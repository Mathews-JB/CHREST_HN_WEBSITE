<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Events | CREST HN Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <!-- Mobile Toggle -->
    <button class="sidebar-toggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="#000">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
        </svg>
    </button>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>CREST HN</h2>
            <p>Admin Panel</p>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="manage-events.html" class="nav-link active">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2.41 0.89-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                    </svg>
                    <span>Events</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="manage-projects.html" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 6h16v2H4zm2 4h12v2H6zm2 4h8v2H8zm-4 4h16v2H4zm2-4h12v2H6z" />
                    </svg>
                    <span>Projects</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="manage-admins.html" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Admins</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="facebook-settings.html" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7h-2.54v-2.9h2.54V9.82c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.23.19 2.23.19v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.45 2.9h-2.33v7a10 10 0 0 0 8.44-9.9c0-5.53-4.5-10.02-10-10.02z" />
                    </svg>
                    <span>Facebook</span>
                </a>
            </li>
        </ul>

        <a href="#" class="logout-btn" onclick="logout()">
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path
                    d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" />
            </svg>
            <span>Logout</span>
        </a>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <div class="page-title">
                <h1>Manage Events</h1>
            </div>
            <button class="btn-primary" onclick="openModal('add')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
                Add New Event
            </button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Date</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="eventsTableBody">
                    <!-- Loaded dynamically -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Event</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventId" name="id">
                    <input type="hidden" id="existingImage" name="existing_image">
                    <input type="hidden" id="existingVideo" name="existing_video">

                    <div class="form-group">
                        <label for="title">Event Title</label>
                        <input type="text" id="title" name="title" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="event_date">Event Date</label>
                            <input type="date" id="event_date" name="event_date" required>
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" name="location" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status">
                            <option value="active">Active</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="image">Event Image</label>
                        <input type="file" id="image" name="image" accept="image/*"
                            onchange="previewImage(this, 'imgPreview')">
                        <img id="imgPreview"
                            style="max-width: 100%; margin-top: 1rem; display: none; border-radius: 8px;">
                    </div>

                    <div class="form-group">
                        <label for="video">Event Video (Optional)</label>
                        <input type="file" id="video" name="video" accept="video/*"
                            onchange="previewVideo(this, 'vidPreview')">
                        <video id="vidPreview" controls
                            style="max-width: 100%; margin-top: 1rem; display: none; border-radius: 8px;"></video>
                    </div>

                    <button type="submit" class="btn-primary" style="width: 100%; justify-content: center;">Save
                        Event</button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script>
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        let currentEvents = [];

        // Load events
        async function loadEvents() {
            try {
                const response = await fetch('../php/api/events.php?all=true'); // assuming api accepts all=true to show non-active too if needed, or modify api
                const data = await response.json();

                if (data.success) {
                    currentEvents = data.events;
                    const tbody = document.getElementById('eventsTableBody');
                    tbody.innerHTML = '';

                    data.events.forEach(event => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><img src="../${event.image_url || 'assets/placeholder-event.jpg'}" alt="${event.title}"></td>
                            <td>${event.title}</td>
                            <td>${new Date(event.event_date).toLocaleDateString()}</td>
                            <td>${event.location}</td>
                            <td><span class="status-badge status-${event.status || 'active'}">${event.status || 'active'}</span></td>
                            <td>
                                <button class="action-btn btn-edit" onclick="editEvent(${event.id})">âœŽ</button>
                                <button class="action-btn btn-delete" onclick="deleteEvent(${event.id})">ðŸ—‘</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // Open modal
        function openModal(mode, id = null) {
            modal.classList.add('active');
            if (mode === 'add') {
                document.getElementById('modalTitle').textContent = 'Add New Event';
                form.reset();
                document.getElementById('eventId').value = '';
                document.getElementById('imgPreview').style.display = 'none';
            }
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        // Edit event
        function editEvent(id) {
            const event = currentEvents.find(e => e.id == id);
            if (event) {
                openModal('edit');
                document.getElementById('modalTitle').textContent = 'Edit Event';
                document.getElementById('eventId').value = event.id;
                document.getElementById('title').value = event.title;
                document.getElementById('event_date').value = event.event_date.split(' ')[0]; // safely handle datetime
                document.getElementById('location').value = event.location;
                document.getElementById('description').value = event.description;
                document.getElementById('status').value = event.status;
                document.getElementById('existingImage').value = event.image_url || '';
                document.getElementById('existingVideo').value = event.video_url || '';

                const imgPreview = document.getElementById('imgPreview');
                const vidPreview = document.getElementById('vidPreview');

                imgPreview.style.display = 'none';
                vidPreview.style.display = 'none';

                if (event.image_url) {
                    imgPreview.src = '../' + event.image_url;
                    imgPreview.style.display = 'block';
                }

                if (event.video_url) {
                    vidPreview.src = '../' + event.video_url;
                    vidPreview.style.display = 'block';
                }
            }
        }

        // Delete event
        async function deleteEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'delete');
                    formData.append('id', id);

                    const response = await fetch('../php/admin/events_crud.php', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        showAlert('Event deleted successfully');
                        loadEvents();
                    } else {
                        showAlert('Error deleting event: ' + data.message, 'error');
                    }
                } catch (error) {
                    showAlert('Error deleting event', 'error');
                }
            }
        }

        // Form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const id = document.getElementById('eventId').value;
            formData.append('action', id ? 'update' : 'create');

            try {
                const response = await fetch('../php/admin/events_crud.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(id ? 'Event updated successfully' : 'Event created successfully');
                    closeModal();
                    loadEvents();
                } else {
                    showAlert(data.message || 'Error saving event', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('An error occurred', 'error');
            }
        });

        // Initialize
        loadEvents();
    </script>
</body>

</html>